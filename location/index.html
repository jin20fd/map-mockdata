<!DOCTYPE html>
<html lang="ko">
<head>
  <title>ì£¼ì†Œ ê²€ìƒ‰ ë° ì¢Œí‘œ ì„ íƒ</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    #map { height: 100%; }
    .output-panel { position: absolute; top: 10px; right: 10px; width: 350px; max-height: 95%; overflow-y: auto; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: flex; flex-direction: column; gap: 15px; }
    .output-panel h4 { margin: 0 0 8px 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .search-container { display: flex; gap: 8px; }
    #address-search-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 14px; }
    #address-search-btn { border: none; background-color: #007bff; color: white; padding: 0 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    #address-search-btn:hover { background-color: #0056b3; }
    .address-info { font-size: 13px; color: #555; background-color: #f0f0f0; padding: 10px; border-radius: 4px; border: 1px solid #ddd; word-break: keep-all; }
    .address-info strong { color: #000; }
    ul#coord-list { list-style-type: none; margin: 0; padding: 0; font-size: 13px; color: #444; }
    ul#coord-list li { display: flex; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #f0f0f0; gap: 10px; }
    ul#coord-list li:last-child { border-bottom: none; }
    .list-item-index { background-color: #dc3545; color: white; font-weight: bold; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .list-item-details { flex-grow: 1; word-break: keep-all; }
    .list-item-details p { margin: 0 0 4px 0; font-size: 12px; }
    .list-item-details p strong { color: #555; }
    .list-item-details p:last-child { margin-bottom: 0; }
    .delete-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; align-self: center; }
    .delete-btn:hover { background: #d93636; }
    .clear-btn { width: 100%; padding: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; background-color: #dc3545; }
    .clear-btn:hover { background-color: #c82333; }
    .marker-number-icon { background-color: #dc3545; color: white; font-weight: bold; font-size: 14px; text-align: center; line-height: 24px; border-radius: 50%; width: 24px; height: 24px; border: 2px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.4); }
    #map { height: 100%; }

    /* ìš°ì¸¡ ì •ë³´ íŒ¨ë„ */
    .output-panel {
      position: absolute; top: 10px; right: 10px;
      width: 350px; max-height: 95%; overflow-y: auto;
      background: rgba(255, 255, 255, 0.95); padding: 15px;
      border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000; display: flex; flex-direction: column; gap: 15px;
    }
    .output-panel h4 { margin: 0 0 8px 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    
    /* ì£¼ì†Œ ê²€ìƒ‰ ì˜ì—­ */
    .search-container { display: flex; gap: 8px; }
    #address-search-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 14px; }
    #address-search-btn { border: none; background-color: #007bff; color: white; padding: 0 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    #address-search-btn:hover { background-color: #0056b3; }

    /* ì£¼ì†Œ ì •ë³´ ì˜ì—­ */
    .address-info { font-size: 13px; color: #555; background-color: #f0f0f0; padding: 10px; border-radius: 4px; border: 1px solid #ddd; word-break: keep-all; }
    .address-info strong { color: #000; }

    /* ì¢Œí‘œ ëª©ë¡ */
    ul#coord-list { list-style-type: none; margin: 0; padding: 0; font-size: 13px; color: #444; }
    ul#coord-list li { display: flex; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #f0f0f0; gap: 10px; }
    ul#coord-list li:last-child { border-bottom: none; }
    .list-item-index { background-color: #dc3545; color: white; font-weight: bold; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .list-item-details { flex-grow: 1; word-break: keep-all; }
    .list-item-details p { margin: 0 0 4px 0; font-size: 12px; }
    .list-item-details p strong { color: #555; }
    .list-item-details p:last-child { margin-bottom: 0; }
    .delete-btn { background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; align-self: center; }
    .delete-btn:hover { background: #d93636; }
    
    /* ë²„íŠ¼ */
    .clear-btn { width: 100%; padding: 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; background-color: #dc3545; }
    .clear-btn:hover { background-color: #c82333; }

    /* âœ¨ ìˆ«ì ë§ˆì»¤ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    .marker-number-icon {
      background-color: #dc3545;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      line-height: 24px;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      border: 2px solid white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>

  <div id="map"></div>
  
  <div class="output-panel">
    <div>
      <h4>ğŸ—ºï¸ ì£¼ì†Œë¡œ ê²€ìƒ‰</h4>
      <div class="search-container">
        <input type="text" id="address-search-input" placeholder="ì „ì²´ ì£¼ì†Œ ë˜ëŠ” ë„ë¡œëª… ì…ë ¥...">
        <button id="address-search-btn">ê²€ìƒ‰</button>
      </div>
    </div>
    <div>
      <h4>ğŸ“ ë§ˆì§€ë§‰ ì¶”ê°€ ìœ„ì¹˜</h4>
      <div id="full-address" class="address-info"><strong>ì „ì²´ ì£¼ì†Œ:</strong> ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.</div>
      <div id="road-address" class="address-info" style="margin-top: 5px;"><strong>ë„ë¡œëª… ì£¼ì†Œ:</strong> ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.</div>
    </div>
    <div>
      <h4>ğŸ“‹ ì €ì¥ëœ ìœ„ì¹˜ ëª©ë¡</h4>
      <ul id="coord-list"></ul>
    </div>
    <div>
      <button id="clear-btn" class="clear-btn">ëª¨ë‘ ì§€ìš°ê¸°</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- 1. ì´ˆê¸° ì„¤ì • (ì´ì „ê³¼ ë™ì¼) ---
    const map = L.map('map').setView([37.6543, 127.0565], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const fullAddressDiv = document.getElementById("full-address");
    const roadAddressDiv = document.getElementById("road-address");
    const coordList = document.getElementById("coord-list");
    const clearBtn = document.getElementById("clear-btn");
    const searchInput = document.getElementById("address-search-input");
    const searchBtn = document.getElementById("address-search-btn");

    let selectedPlaces = [];
    // --- 2. ë…¸ì›êµ¬ ê²½ê³„ ì‹œê°í™” (âœ¨ ì¢Œí‘œ ì§ì ‘ ì‚½ì…) ---
    const nowonBoundary = [
        [37.6923, 127.0545], [37.6835, 127.0772], [37.6698, 127.0833],
        [37.6543, 127.0955], [37.6381, 127.0815], [37.6200, 127.0759],
        [37.6186, 127.0601], [37.6339, 127.0441], [37.6493, 127.0530],
        [37.6749, 127.0321], [37.6923, 127.0545]
    ];
    
    // í´ë¦¬ê³¤ ë ˆì´ì–´ ìƒì„± ë° ì§€ë„ì— ì¶”ê°€
    const polygon = L.polygon(nowonBoundary, { 
        color: 'blue',      // ì„  ìƒ‰ìƒ
        weight: 2,          // ì„  êµµê¸°
        fillOpacity: 0.1    // ì±„ìš°ê¸° íˆ¬ëª…ë„
    }).addTo(map);

    // ì§€ë„ ë²”ìœ„ë¥¼ í´ë¦¬ê³¤ì— ë§ì¶¤
    map.fitBounds(polygon.getBounds());

    // --- 3. ì£¼ì†Œ ë³€í™˜ ë° ë§ˆì»¤/ëª©ë¡ ì¶”ê°€ (ê³µí†µ í•¨ìˆ˜) ---
    async function addPlace(lat, lng) {
        const latFixed = parseFloat(lat.toFixed(6));
        const lngFixed = parseFloat(lng.toFixed(6));
        const addresses = await getAddressFromCoords(latFixed, lngFixed);
        
        fullAddressDiv.innerHTML = `<strong>ì „ì²´ ì£¼ì†Œ:</strong> ${addresses.fullAddress}`;
        roadAddressDiv.innerHTML = `<strong>ë„ë¡œëª… ì£¼ì†Œ:</strong> ${addresses.roadAddress}`;
        
        // âœ¨ ë§ˆì»¤ëŠ” ì•„ì§ ì§€ë„ì— ì¶”ê°€í•˜ì§€ ì•Šê³  ë°ì´í„°ë§Œ ìƒì„±
        const newPlace = {
            id: Date.now(),
            lat: latFixed,
            lng: lngFixed,
            fullAddress: addresses.fullAddress,
            roadAddress: addresses.roadAddress,
            marker: L.marker([latFixed, lngFixed]) // ë§ˆì»¤ ê°ì²´ë§Œ ìƒì„±
        };

        selectedPlaces.push(newPlace);
        
        // âœ¨ ë§ˆì»¤ì™€ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í†µí•© í•¨ìˆ˜ í˜¸ì¶œ
        updateMarkersAndList();
        
        // ë§ˆì§€ë§‰ì— ì¶”ê°€ëœ ë§ˆì»¤ì˜ íŒì—… ì—´ê¸°
        newPlace.marker.openPopup();
    }
    
    // --- 4. ë§ˆì»¤ì™€ ëª©ë¡ì„ ë™ê¸°í™”í•˜ì—¬ ì—…ë°ì´íŠ¸í•˜ëŠ” í†µí•© í•¨ìˆ˜ (âœ¨ í•µì‹¬ ë³€ê²½) ---
    function updateMarkersAndList() {
        coordList.innerHTML = ""; // ëª©ë¡ ì´ˆê¸°í™”

        selectedPlaces.forEach((place, index) => {
            const number = index + 1;

            // ì•„ì´ì½˜ ìƒì„±
            const numberIcon = L.divIcon({
                className: 'marker-number-icon',
                html: `<b>${number}</b>`,
                iconSize: [24, 24],
                iconAnchor: [14, 14] // ì•„ì´ì½˜ ìœ„ì¹˜ ì¡°ì •
            });

            // ë§ˆì»¤ì— ì•„ì´ì½˜ ì„¤ì •í•˜ê³  ì§€ë„ì— ì¶”ê°€
            place.marker.setIcon(numberIcon);
            if (!map.hasLayer(place.marker)) {
                place.marker.addTo(map);
            }
            
            // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
            place.marker.bindPopup(`<b>${number}. ${place.roadAddress}</b><br>${place.fullAddress}`);
            
            // ëª©ë¡(li) ìƒì„±
            const li = document.createElement("li");
            li.innerHTML = `
                <div class="list-item-index">${number}</div>
                <div class="list-item-details">
                    <p><strong>ë„ë¡œëª…:</strong> ${place.roadAddress}</p>
                    <p><strong>ì „ì²´:</strong> ${place.fullAddress}</p>
                    <p><strong>ì¢Œí‘œ:</strong> (${place.lat}, ${place.lng})</p>
                </div>
                <button class="delete-btn" data-id="${place.id}">ì‚­ì œ</button>
            `;
            coordList.appendChild(li);
        });
    }

    // --- 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ê¸°íƒ€ í•¨ìˆ˜ (getAddressFromCoords ë“±ì€ ì´ì „ê³¼ ë™ì¼) ---
    async function getAddressFromCoords(lat, lng) {
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("ì£¼ì†Œ API í˜¸ì¶œ ì‹¤íŒ¨");
            const data = await res.json();
            const fullAddress = data.display_name || "ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ";
            const details = data.address;
            let roadAddress = "ë„ë¡œëª… ì£¼ì†Œ ì—†ìŒ";
            if (details && details.road) {
                roadAddress = `${details.road} ${details.house_number || ''}`.trim();
            }
            return { fullAddress, roadAddress };
        } catch (error) {
            return { fullAddress: "ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨", roadAddress: "ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨" };
        }
    }

    map.on("click", (e) => addPlace(e.latlng.lat, e.latlng.lng));
    
    async function searchByAddress() {
        const query = searchInput.value.trim();
        if (!query) return;
        try {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&countrycodes=kr`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("ê²€ìƒ‰ API í˜¸ì¶œ ì‹¤íŒ¨");
            const data = await res.json();
            if (data.length > 0) {
                const { lat, lon } = data[0];
                map.flyTo([lat, lon], 16);
                addPlace(parseFloat(lat), parseFloat(lon));
                searchInput.value = "";
            } else {
                alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        } catch (error) {
            alert("ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
    
    searchBtn.addEventListener('click', searchByAddress);
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') searchByAddress();
    });

    // âœ¨ ì‚­ì œ ë¡œì§ ìˆ˜ì •
    coordList.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn')) {
            const placeId = Number(e.target.dataset.id);
            const placeToRemove = selectedPlaces.find(p => p.id === placeId);
            if (placeToRemove) {
                map.removeLayer(placeToRemove.marker); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
                selectedPlaces = selectedPlaces.filter(p => p.id !== placeId); // ë°°ì—´ì—ì„œ ë°ì´í„° ì œê±°
                updateMarkersAndList(); // âœ¨ ë§ˆì»¤ì™€ ëª©ë¡ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¼ (ë²ˆí˜¸ ì¬ì •ë ¬)
            }
        }
    });

    clearBtn.addEventListener('click', () => {
      selectedPlaces.forEach(p => map.removeLayer(p.marker));
      selectedPlaces = [];
      updateMarkersAndList(); // ëª©ë¡ì„ ë¹„ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¼
      fullAddressDiv.innerHTML = `<strong>ì „ì²´ ì£¼ì†Œ:</strong> ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.`;
      roadAddressDiv.innerHTML = `<strong>ë„ë¡œëª… ì£¼ì†Œ:</strong> ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.`;
    });
  </script>
</body>
</html>